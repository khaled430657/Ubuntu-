name: CI Linux Chrome Remote Desktop

on:
  workflow_dispatch:
    inputs:
      crd_code:
        description: 'ضع كود Debian Linux هنا (يبدأ بـ DISPLAY= /opt/google...)'
        required: true
      pin:
        description: 'PIN (6 أرقام)'
        required: true
        default: '123456'

jobs:
  build-and-connect:
    runs-on: ubuntu-latest
    timeout-minutes: 3600

    steps:
      - name: Install Desktop Environment (XFCE)
        run: |
          sudo apt-get update
          # تثبيت واجهة XFCE الخفيفة
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y xfce4 desktop-base xfce4-terminal
          
          # إزالة أدوات قد تسبب تعارضاً
          sudo apt-get remove -y gnome-terminal
          
          # إعداد الشاشة الافتراضية لتعمل بدقة جيدة
          echo "xfce4-session" > ~/.chrome-remote-desktop-session

      - name: Install Google Chrome & Remote Desktop
        run: |
          # تحميل وتثبيت متصفح كروم
          wget https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb
          sudo apt install -y ./google-chrome-stable_current_amd64.deb
          
          # تحميل وتثبيت Chrome Remote Desktop
          wget https://dl.google.com/linux/direct/chrome-remote-desktop_current_amd64.deb
          sudo apt install -y ./chrome-remote-desktop_current_amd64.deb
          
          # إصلاح التبعيات إن وجدت
          sudo apt-get install --fix-broken -y

      - name: Configure User Session
        run: |
          # إضافة المستخدم الحالي لمجموعة Chrome Remote Desktop
          sudo usermod -aG chrome-remote-desktop $USER
          
          # التأكد من ملف الجلسة
          mkdir -p ~/.config/chrome-remote-desktop
          chown "$USER:$USER" ~/.config/chrome-remote-desktop

      - name: Start Chrome Remote Desktop
        run: |
          # تشغيل الأمر الذي أدخله المستخدم مع إضافة الـ PIN
          # يتم تنفيذ الأمر في الخلفية
          CMD="${{ github.event.inputs.crd_code }}"
          PIN="${{ github.event.inputs.pin }}"
          
          # تنظيف الأمر للتأكد من أنه يعمل بشكل صحيح وإضافة الـ PIN
          full_cmd="$CMD --pin=$PIN"
          
          echo "Starting Chrome Remote Desktop..."
          eval "$full_cmd"

      - name: Keep Alive
        run: |
          echo "Chrome Remote Desktop is running!"
          echo "Go to https://remotedesktop.google.com/access to connect."
          # حلقة لمنع السيرفر من الإغلاق
          while true; do sleep 300; echo "System active $(date)"; done
