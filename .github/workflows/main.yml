name: CI Build Linux XFCE Fixed

on:
  workflow_dispatch:

jobs:
  secure-rdp-xfce:
    runs-on: ubuntu-latest
    timeout-minutes: 3600

    steps:
      - name: Update and Install XFCE (Fixed)
        run: |
          sudo apt-get update
          # تثبيت XFCE مع حزمة dbus-x11 الضرورية جداً لمنع خطأ failsafe
          sudo apt-get install -y xfce4 xfce4-goodies xrdp dbus-x11 x11-xserver-utils
          
          # تنظيف إعدادات XRDP القديمة وتجهيزها لـ XFCE
          sudo sed -i.bak '/test -x/d' /etc/xrdp/startwm.sh
          sudo sed -i.bak '/exec/d' /etc/xrdp/startwm.sh
          
          # إجبار XRDP على تشغيل XFCE4 عند البدء
          echo "startxfce4" | sudo tee -a /etc/xrdp/startwm.sh
          sudo chmod +x /etc/xrdp/startwm.sh
          
          # تعديل المنفذ
          sudo sed -i 's/3389/3389/g' /etc/xrdp/xrdp.ini
          
          sudo service xrdp start

      - name: Create RDP User
        id: create_user
        run: |
          USERNAME="linux_rdp"
          PASSWORD=$(openssl rand -base64 12)
          
          sudo useradd -m -s /bin/bash $USERNAME
          echo "$USERNAME:$PASSWORD" | sudo chpasswd
          sudo usermod -aG sudo $USERNAME
          
          echo "RDP_USER=$USERNAME" >> $GITHUB_ENV
          echo "RDP_PASS=$PASSWORD" >> $GITHUB_ENV
          
          # إعداد ملف الجلسة للمستخدم (مهم جداً)
          sudo -u $USERNAME sh -c 'echo "xfce4-session" > /home/linux_rdp/.xsession'
          # إضافة متغيرات بيئة لإصلاح أي مشاكل في العرض
          sudo -u $USERNAME sh -c 'echo "export GL_VENDOR=Mesa" >> /home/linux_rdp/.xsessionrc'
          sudo -u $USERNAME sh -c 'echo "export XDG_SESSION_TYPE=x11" >> /home/linux_rdp/.xsessionrc'

      - name: Install Tailscale
        run: |
          curl -fsSL https://tailscale.com/install.sh | sh

      - name: Establish Tailscale Connection
        run: |
          # تأكد أن المفتاح في Secrets صالح
          sudo tailscale up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=gh-linux-xfce-$GITHUB_RUN_ID
          
          TS_IP=$(tailscale ip -4)
          echo "TAILSCALE_IP=$TS_IP" >> $GITHUB_ENV

      - name: Maintain Connection & Display Info
        run: |
          echo "=========================================="
          echo "   LINUX (XFCE) RDP ACCESS DETAILS"
          echo "=========================================="
          echo "IP Address (Tailscale): $TAILSCALE_IP"
          echo "Username: $RDP_USER"
          echo "Password: $RDP_PASS"
          echo "=========================================="
          echo "RDP Server is running on port 3389"
          echo "Use 'Remmina' or Windows 'Remote Desktop Connection' to connect."
          
          while true; do
            sleep 300
            echo "[$(date)] RDP Active - Runner is alive..."
          done
