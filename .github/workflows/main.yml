name: CI Build Linux XFCE (Final Fix)

on:
  workflow_dispatch:

jobs:
  secure-rdp-xfce-fix:
    runs-on: ubuntu-latest
    timeout-minutes: 3600

    steps:
      - name: Update and Install XFCE & Dependencies
        run: |
          sudo apt-get update
          # تثبيت الواجهة و dbus-x11 (مهم جداً للحل)
          sudo apt-get install -y xfce4 xfce4-goodies xrdp dbus-x11 x11-xserver-utils
          
          # ---------------------------------------------------
          # الخطوة السحرية لإصلاح خطأ Failsafe / D-Bus
          # نقوم بمسح ملف البدء القديم وإنشاء واحد جديد ونظيف تماماً
          # ---------------------------------------------------
          sudo rm /etc/xrdp/startwm.sh
          
          # كتابة ملف تشغيل جديد يقوم بإلغاء المتغيرات المتعارضة
          echo "#!/bin/sh" | sudo tee /etc/xrdp/startwm.sh
          echo "unset DBUS_SESSION_BUS_ADDRESS" | sudo tee -a /etc/xrdp/startwm.sh
          echo "unset XDG_RUNTIME_DIR" | sudo tee -a /etc/xrdp/startwm.sh
          echo "exec startxfce4" | sudo tee -a /etc/xrdp/startwm.sh
          
          # إعطاء صلاحية التنفيذ
          sudo chmod +x /etc/xrdp/startwm.sh
          
          # تعديل المنفذ وتشغيل الخدمة
          sudo sed -i 's/3389/3389/g' /etc/xrdp/xrdp.ini
          sudo service xrdp start

      - name: Create RDP User
        id: create_user
        run: |
          USERNAME="linux_rdp"
          PASSWORD=$(openssl rand -base64 12)
          
          sudo useradd -m -s /bin/bash $USERNAME
          echo "$USERNAME:$PASSWORD" | sudo chpasswd
          sudo usermod -aG sudo $USERNAME
          
          # حفظ البيانات
          echo "RDP_USER=$USERNAME" >> $GITHUB_ENV
          echo "RDP_PASS=$PASSWORD" >> $GITHUB_ENV
          
          # إنشاء ملف الجلسة للمستخدم كإجراء احتياطي
          sudo -u $USERNAME sh -c 'echo "xfce4-session" > /home/linux_rdp/.xsession'

      - name: Install Tailscale
        run: |
          curl -fsSL https://tailscale.com/install.sh | sh

      - name: Establish Tailscale Connection
        run: |
          # تأكد أن المفتاح في Secrets صالح
          sudo tailscale up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=gh-linux-xfce-fix-$GITHUB_RUN_ID
          
          TS_IP=$(tailscale ip -4)
          echo "TAILSCALE_IP=$TS_IP" >> $GITHUB_ENV

      - name: Maintain Connection & Display Info
        run: |
          echo "=========================================="
          echo "   LINUX (XFCE) FIXED RDP DETAILS"
          echo "=========================================="
          echo "IP Address (Tailscale): $TAILSCALE_IP"
          echo "Username: $RDP_USER"
          echo "Password: $RDP_PASS"
          echo "=========================================="
          echo "NOTE: If you see a black screen initially, wait 10 seconds."
          
          while true; do
            sleep 300
            echo "[$(date)] RDP Active..."
          done
