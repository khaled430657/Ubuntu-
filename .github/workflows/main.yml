name: CI Build Linux

on:
  workflow_dispatch:

jobs:
  secure-rdp-linux:
    runs-on: ubuntu-latest
    timeout-minutes: 3600

    steps:
      - name: Update and Install Desktop Environment (XFCE & XRDP)
        run: |
          sudo apt-get update
          sudo apt-get install -y xfce4 xfce4-goodies xrdp
          echo "xfce4-session" > ~/.xsession
          sudo sed -i 's/3389/3389/g' /etc/xrdp/xrdp.ini
          sudo service xrdp start

      - name: Create RDP User with Secure Password
        id: create_user
        run: |
          USERNAME="linux_rdp"
          PASSWORD=$(openssl rand -base64 12)
          
          sudo useradd -m -s /bin/bash $USERNAME
          echo "$USERNAME:$PASSWORD" | sudo chpasswd
          sudo usermod -aG sudo $USERNAME
          
          # --- التصحيح هنا: استخدام $GITHUB_ENV بدلاً من $env:GITHUB_ENV ---
          echo "RDP_USER=$USERNAME" >> $GITHUB_ENV
          echo "RDP_PASS=$PASSWORD" >> $GITHUB_ENV
          
          sudo -u $USERNAME sh -c 'echo "xfce4-session" > /home/linux_rdp/.xsession'

      - name: Install Tailscale
        run: |
          curl -fsSL https://tailscale.com/install.sh | sh

      - name: Establish Tailscale Connection
        run: |
          # تأكد أن المفتاح في Secrets صالح
          sudo tailscale up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=gh-linux-runner-$GITHUB_RUN_ID
          
          # حفظ الـ IP في متغيرات البيئة
          TS_IP=$(tailscale ip -4)
          echo "TAILSCALE_IP=$TS_IP" >> $GITHUB_ENV

      - name: Maintain Connection & Display Info
        run: |
          echo "=========================================="
          echo "   LINUX RDP ACCESS DETAILS"
          echo "=========================================="
          echo "IP Address (Tailscale): $TAILSCALE_IP"
          echo "Username: $RDP_USER"
          echo "Password: $RDP_PASS"
          echo "=========================================="
          echo "RDP Server is running on port 3389"
          echo "Use 'Remmina' or Windows 'Remote Desktop Connection' to connect."
          
          while true; do
            sleep 300
            echo "[$(date)] RDP Active - Runner is alive..."
          done
