name: CI Build Linux GNOME

on:
  workflow_dispatch:

jobs:
  secure-rdp-gnome:
    runs-on: ubuntu-latest
    timeout-minutes: 3600

    steps:
      - name: Update and Install GNOME Desktop & XRDP
        run: |
          sudo apt-get update
          # تثبيت واجهة أوبونتو الرسمية (GNOME)
          # ملاحظة: هذا التثبيت حجمه كبير وقد يستغرق وقتاً
          sudo apt-get install -y ubuntu-desktop xrdp
          
          # إصلاح مشاكل الصلاحيات الشائعة في XRDP مع GNOME
          sudo adduser xrdp ssl-cert
          sudo sed -i 's/3389/3389/g' /etc/xrdp/xrdp.ini
          
          # السماح لجلسة Gnome بالعمل مع XRDP
          sudo sed -i 's/allowed_users=console/allowed_users=anybody/g' /etc/X11/Xwrapper.config

          # تشغيل الخدمة
          sudo service xrdp start

      - name: Create RDP User with GNOME Config
        id: create_user
        run: |
          USERNAME="linux_rdp"
          PASSWORD=$(openssl rand -base64 12)
          
          # إنشاء المستخدم
          sudo useradd -m -s /bin/bash $USERNAME
          echo "$USERNAME:$PASSWORD" | sudo chpasswd
          sudo usermod -aG sudo $USERNAME
          
          # حفظ البيانات بشكل صحيح في متغيرات البيئة
          echo "RDP_USER=$USERNAME" >> $GITHUB_ENV
          echo "RDP_PASS=$PASSWORD" >> $GITHUB_ENV
          
          # --- الخطوة الحاسمة لتشغيل GNOME وإصلاح خطأ Failsafe ---
          # إنشاء ملف .xsession يجبر النظام على تشغيل gnome-session
          sudo -u $USERNAME sh -c 'echo "gnome-session" > /home/linux_rdp/.xsession'
          
          # إعدادات إضافية لتحسين التوافق مع RDP
          sudo -u $USERNAME sh -c 'echo "export GNOME_SHELL_SESSION_MODE=ubuntu" > /home/linux_rdp/.xsessionrc'
          sudo -u $USERNAME sh -c 'echo "export XDG_CURRENT_DESKTOP=ubuntu:GNOME" >> /home/linux_rdp/.xsessionrc'
          sudo -u $USERNAME sh -c 'echo "export XDG_CONFIG_DIRS=/etc/xdg/xdg-ubuntu:/etc/xdg" >> /home/linux_rdp/.xsessionrc'

      - name: Install Tailscale
        run: |
          curl -fsSL https://tailscale.com/install.sh | sh

      - name: Establish Tailscale Connection
        run: |
          # تأكد من تحديث المفتاح في GitHub Secrets
          sudo tailscale up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=gh-linux-gnome-$GITHUB_RUN_ID
          
          TS_IP=$(tailscale ip -4)
          echo "TAILSCALE_IP=$TS_IP" >> $GITHUB_ENV

      - name: Maintain Connection & Display Info
        run: |
          echo "=========================================="
          echo "   LINUX (GNOME) RDP ACCESS DETAILS"
          echo "=========================================="
          echo "IP Address (Tailscale): $TAILSCALE_IP"
          echo "Username: $RDP_USER"
          echo "Password: $RDP_PASS"
          echo "=========================================="
          echo "RDP Server is running on port 3389"
          echo "Wait a few seconds after login for GNOME to load..."
          
          while true; do
            sleep 300
            echo "[$(date)] RDP Active - Runner is alive..."
          done
